name: Organization Monitor - Auto Scan All Repos

on:
  # Run daily at 3 AM UTC
  schedule:
    - cron: '0 3 * * *'
  
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      create_issues:
        description: 'Create GitHub issues for findings'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
      max_repos:
        description: 'Max repositories to scan (0 = all)'
        required: false
        default: '0'

permissions:
  contents: write
  issues: write
  pull-requests: read
  actions: read

jobs:
  scan-all-repos:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install requests PyYAML
      
      - name: Run organization monitor
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_USER: ${{ github.repository_owner }}
          CREATE_ISSUES: ${{ github.event.inputs.create_issues || 'false' }}
          MAX_REPOS: ${{ github.event.inputs.max_repos || '0' }}
        run: |
          python org_monitor_agent.py
      
      - name: Upload scan report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: org-monitor-report-${{ github.run_number }}
          path: org_monitor_report.txt
          retention-days: 90
      
      - name: Check for critical issues
        id: check-critical
        run: |
          if grep -q "Critical issues:" org_monitor_report.txt; then
            CRITICAL_COUNT=$(grep "Critical issues:" org_monitor_report.txt | awk '{print $3}')
            echo "critical_count=$CRITICAL_COUNT" >> $GITHUB_OUTPUT
            
            if [ "$CRITICAL_COUNT" -gt "0" ]; then
              echo "has_critical=true" >> $GITHUB_OUTPUT
            else
              echo "has_critical=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "has_critical=false" >> $GITHUB_OUTPUT
            echo "critical_count=0" >> $GITHUB_OUTPUT
          fi
      
      - name: Create summary issue (if critical issues found)
        if: steps.check-critical.outputs.has_critical == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('org_monitor_report.txt', 'utf8');
            
            const issueBody = `## ðŸš¨ Critical Issues Found in Organization Scan
            
**Scan Date:** ${new Date().toISOString()}
**Run:** [View Details](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

### Summary

Critical issues detected: **${{ steps.check-critical.outputs.critical_count }}**

### Full Report

\`\`\`
${report.substring(0, 50000)}
\`\`\`

### Actions Required

1. Review the full report in the workflow artifacts
2. Address critical issues immediately
3. Review and apply suggested fixes

---
*Generated by Organization Monitor Agent*
`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[Auto] Critical Issues Found - ${new Date().toISOString().split('T')[0]}`,
              body: issueBody,
              labels: ['automated', 'critical', 'organization-health']
            });
      
      - name: Send Slack notification (if critical)
        if: steps.check-critical.outputs.has_critical == 'true' && vars.SLACK_WEBHOOK
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              text: ':rotating_light: Critical Issues Found in Organization Scan',
              attachments: [{
                color: 'danger',
                fields: [
                  {
                    title: 'Critical Issues',
                    value: '${{ steps.check-critical.outputs.critical_count }}',
                    short: true
                  },
                  {
                    title: 'Scan Date',
                    value: '${new Date().toISOString()}',
                    short: true
                  }
                ],
                actions: [{
                  type: 'button',
                  text: 'View Report',
                  url: '${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'
                }]
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
      
      - name: Post success summary
        if: steps.check-critical.outputs.has_critical == 'false'
        run: |
          echo "âœ… No critical issues found in organization scan"
          echo "ðŸ“Š Check the uploaded artifact for detailed analysis"
